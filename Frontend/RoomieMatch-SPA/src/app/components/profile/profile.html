<div class="container">
    <div class="profile-header">
        <h2>My Profile</h2>
        <p>Manage your details and preferences</p>
    </div>

    <!-- Profile Completion Bar -->
    <div *ngIf="!loading && user" class="completion-card">
        <div class="completion-header">
            <span class="completion-title">Profile Completion</span>
            <span class="completion-percent" [class.complete]="getProfileCompletion() === 100">
                {{ getProfileCompletion() }}%
            </span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" [style.width.%]="getProfileCompletion()"></div>
        </div>
        <div class="missing-fields" *ngIf="getMissingFields().length > 0">
            <span class="missing-label">Missing:</span>
            <span class="missing-item" *ngFor="let field of getMissingFields()">{{ field }}</span>
        </div>
        <div class="completion-success" *ngIf="getMissingFields().length === 0">
            ðŸŽ‰ Your profile is complete!
        </div>
    </div>

    <div *ngIf="loading" class="loading-spinner">
        Loading...
    </div>

    <form *ngIf="!loading && user" (ngSubmit)="onSubmit()" #profileForm="ngForm" class="profile-form">

        <!-- User Details Section -->
        <section class="form-section">
            <h3>Personal Information</h3>

            <div class="form-group center-content">
                <div class="avatar-preview" *ngIf="user.profileImage">
                    <img [src]="user.profileImage" alt="Profile Preview" onerror="this.src='assets/default-avatar.png'">
                </div>
                <div class="avatar-placeholder" *ngIf="!user.profileImage">
                    {{ user.firstName[0] }}{{ user.lastName[0] }}
                </div>
            </div>

            <div class="form-group">
                <label for="profileImage">Profile Image</label>
                <div class="file-upload-container">
                    <input type="file" (change)="onFileSelected($event)" accept="image/*" [disabled]="uploadingPhoto">
                    <span *ngIf="uploadingPhoto">Uploading...</span>
                </div>
                <small class="hint">Upload a real photo (max 10MB)</small>
            </div>

            <div class="row">
                <div class="form-group half">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" name="firstName" [(ngModel)]="user.firstName" required>
                </div>
                <div class="form-group half">
                    <label for="lastName">Last Name</label>
                    <input type="text" id="lastName" name="lastName" [(ngModel)]="user.lastName" required>
                </div>
            </div>

            <div class="form-group">
                <label for="age">Age</label>
                <input type="number" id="age" name="age" [(ngModel)]="user.age" required min="18">
            </div>

            <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender" name="gender" [(ngModel)]="user.gender" required>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label for="bio">Bio</label>
                <textarea id="bio" name="bio" [(ngModel)]="user.bio" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="userType">I am...</label>
                <select id="userType" name="userType" [(ngModel)]="user.userType" required>
                    <option value="NEEDS_ROOM">Looking for a Room</option>
                    <option value="HAS_ROOM">Offering a Room</option>
                </select>
            </div>
        </section>



        <!-- Room Details Section (Only for HAS_ROOM) -->
        <section class="form-section" *ngIf="user.userType === 'HAS_ROOM' && user.room">
            <h3>Room Details</h3>
            <p class="section-desc">describe the room you are offering</p>

            <div class="form-group">
                <label for="roomTitle">Title</label>
                <input type="text" id="roomTitle" name="roomTitle" [(ngModel)]="user.room.title" required
                    placeholder="e.g. Cozy Room in NÃ¸rrebro">
            </div>

            <div class="form-group">
                <label for="roomImage">Room Image URL</label>
                <input type="url" id="roomImage" name="roomImage" [(ngModel)]="user.room.roomImage"
                    placeholder="https://example.com/room.jpg">
            </div>

            <div class="form-group">
                <div class="row">
                    <div class="form-group half">
                        <label for="roomRent">Rent (Monthly)</label>
                        <input type="number" id="roomRent" name="roomRent" [(ngModel)]="user.room.rent" required>
                    </div>
                    <div class="form-group half">
                        <label for="roomSize">Size (mÂ²)</label>
                        <input type="number" id="roomSize" name="roomSize" [(ngModel)]="user.room.sizeSqm">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="roomLocation">Location</label>
                <input type="text" id="roomLocation" name="roomLocation" [(ngModel)]="user.room.location" required>
            </div>

            <div class="form-group">
                <label for="roomDescription">Description</label>
                <textarea id="roomDescription" name="roomDescription" [(ngModel)]="user.room.description"
                    rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="availableFrom">Available From</label>
                <input type="date" id="availableFrom" name="availableFrom"
                    [ngModel]="user.room.availableFrom | date:'yyyy-MM-dd'"
                    (ngModelChange)="user.room.availableFrom = $event">
            </div>
        </section>

        <!-- Preferences Section -->
        <section class="form-section">
            <h3>Preferences</h3>
            <p class="section-desc">Help us find better matches for you</p>

            <div class="form-group">
                <label for="maxRent">Maximum Rent ($)</label>
                <input type="number" id="maxRent" name="maxRent" [(ngModel)]="preference.maxRent">
            </div>

            <div class="form-group">
                <label for="preferredLocation">Preferred Location</label>
                <input type="text" id="preferredLocation" name="preferredLocation"
                    [(ngModel)]="preference.preferredLocation">
            </div>

            <div class="form-group">
                <label for="preferredGender">Preferred Roomie Gender</label>
                <select id="preferredGender" name="preferredGender" [(ngModel)]="preference.preferredGender">
                    <option value="Any">Any</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="row">
                <div class="form-group half">
                    <label for="minAge">Min Roomie Age</label>
                    <input type="number" id="minAge" name="minAgeRoomie" [(ngModel)]="preference.minAgeRoomie">
                </div>
                <div class="form-group half">
                    <label for="maxAge">Max Roomie Age</label>
                    <input type="number" id="maxAge" name="maxAgeRoomie" [(ngModel)]="preference.maxAgeRoomie">
                </div>
            </div>
        </section>

        <div class="message success" *ngIf="message">{{ message }}</div>
        <div class="message error" *ngIf="error">{{ error }}</div>

        <div class="form-actions">
            <button type="submit" class="btn-primary" [disabled]="saving">
                {{ saving ? 'Saving...' : 'Save Changes' }}
            </button>
        </div>
    </form>
</div>